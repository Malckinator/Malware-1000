#include "../include/controlInst.h"

bool HLT(CPU* cpu) {
	cpu->pc--;
	return true;
}

bool DAT(CPU* cpu) {
	cpu->gpregs[0] = CPU_VERSION;
	return true;
}

bool INTR(CPU* cpu) {
	cpu->sFlag = true;
	cpu->interupt = true;
	return true;
}

bool RET(CPU* cpu) {
	dword addr = PopInternal(cpu);
	if (!HasPermission(cpu, addr))
		return false;
	cpu->pc = addr;
	return true;
}

bool IRET(CPU* cpu) {
	dword addr = PopInternal(cpu);
	bool perm = (bool) PopInternal(cpu);
	if (cpu->perm)
		return false;
	cpu->pc = addr;
	cpu->perm = perm;
	return true;
}

bool JMP_REG(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	if (!HasPermission(cpu, cpu->gpregs[addr]))
		return false;
	cpu->pc = cpu->gpregs[addr];
	return true;
}

bool JPZ_REG(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte condition = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	if (!HasPermission(cpu, cpu->gpregs[addr]))
		return false;
	if (cpu->gpregs[condition] == 0)
		cpu->pc = cpu->gpregs[addr];
	return true;
}

bool JNZ_REG(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte condition = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	if (!HasPermission(cpu, cpu->gpregs[addr]))
		return false;
	if (cpu->gpregs[condition] != 0)
		cpu->pc = cpu->gpregs[addr];
	return true;
}

bool JL_REG(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	if (!HasPermission(cpu, cpu->gpregs[addr]))
		return false;
	if (cpu->lFlag)
		cpu->pc = cpu->gpregs[addr];
	return true;
}

bool JE_REG(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	if (!HasPermission(cpu, cpu->gpregs[addr]))
		return false;
	if (cpu->eFlag)
		cpu->pc = cpu->gpregs[addr];
	return true;
}

bool JG_REG(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	if (!HasPermission(cpu, cpu->gpregs[addr]))
		return false;
	if (cpu->gFlag)
		cpu->pc = cpu->gpregs[addr];
	return true;
}

bool JMP_IMM(CPU* cpu) {
	dword addr = ReadBus(cpu->bus, cpu->pc, 4);
	if (!HasPermission(cpu, addr))
		return false;
	cpu->pc = addr;
	return true;
}

bool JPZ_IMM(CPU* cpu) {
	dword addr = ReadBus(cpu->bus, cpu->pc, 4);
	byte condition = ReadBus(cpu->bus, cpu->pc + 4, 1) >> 4;
	cpu->pc += 5;
	if (!HasPermission(cpu, addr))
		return false;
	if (cpu->gpregs[condition] == 0)
		cpu->pc = addr;
	return true;
}

bool JNZ_IMM(CPU* cpu) {
	dword addr = ReadBus(cpu->bus, cpu->pc, 4);
	byte condition = ReadBus(cpu->bus, cpu->pc + 4, 1) >> 4;
	cpu->pc += 5;
	if (!HasPermission(cpu, addr))
		return false;
	if (cpu->gpregs[condition] != 0)
		cpu->pc = addr;
	return true;
}

bool JL_IMM(CPU* cpu) {
	dword addr = ReadBus(cpu->bus, cpu->pc, 4);
	cpu->pc += 4;
	if (!HasPermission(cpu, addr))
		return false;
	if (cpu->lFlag)
		cpu->pc = addr;
	return true;
}

bool JE_IMM(CPU* cpu) {
	dword addr = ReadBus(cpu->bus, cpu->pc, 4);
	cpu->pc += 4;
	if (!HasPermission(cpu, addr))
		return false;
	if (cpu->eFlag)
		cpu->pc = addr;
	return true;
}

bool JG_IMM(CPU* cpu) {
	dword addr = ReadBus(cpu->bus, cpu->pc, 4);
	cpu->pc += 4;
	if (!HasPermission(cpu, addr))
		return false;
	if (cpu->gFlag)
		cpu->pc = addr;
	return true;
}

bool CALL_REG(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	if (!HasPermission(cpu, cpu->gpregs[addr]))
		return false;
	PushInternal(cpu, cpu->pc);
	cpu->pc = cpu->gpregs[addr];
	return true;
}

bool CALLZ_REG(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte condition = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	if (!HasPermission(cpu, cpu->gpregs[addr]))
		return false;
	if (cpu->gpregs[condition] == 0) {
		PushInternal(cpu, cpu->pc);
		cpu->pc = cpu->gpregs[addr];
	}
	return true;
}

bool CALLNZ_REG(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte condition = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	if (!HasPermission(cpu, cpu->gpregs[addr]))
		return false;
	if (cpu->gpregs[condition] != 0) {
		PushInternal(cpu, cpu->pc);
		cpu->pc = cpu->gpregs[addr];
	}
	return true;
}

bool CALLL_REG(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	if (!HasPermission(cpu, cpu->gpregs[addr]))
		return false;
	if (cpu->lFlag) {
		PushInternal(cpu, cpu->pc);
		cpu->pc = cpu->gpregs[addr];
	}
	return true;
}

bool CALLE_REG(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	if (!HasPermission(cpu, cpu->gpregs[addr]))
		return false;
	if (cpu->eFlag) {
		PushInternal(cpu, cpu->pc);
		cpu->pc = cpu->gpregs[addr];
	}
	return true;
}

bool CALLG_REG(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	if (!HasPermission(cpu, cpu->gpregs[addr]))
		return false;
	if (cpu->gFlag) {
		PushInternal(cpu, cpu->pc);
		cpu->pc = cpu->gpregs[addr];
	}
	return true;
}

bool CALL_IMM(CPU* cpu) {
	dword addr = ReadBus(cpu->bus, cpu->pc, 4);
	if (!HasPermission(cpu, addr))
		return false;
	PushInternal(cpu, cpu->pc);
	cpu->pc = addr;
	return true;
}

bool CALLZ_IMM(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 4);
	byte condition = ReadBus(cpu->bus, cpu->pc + 4, 1) << 4 >> 4;
	cpu->pc += 5;
	if (!HasPermission(cpu, addr))
		return false;
	if (cpu->gpregs[condition] == 0) {
		PushInternal(cpu, cpu->pc);
		cpu->pc = addr;
	}
	return true;
}

bool CALLNZ_IMM(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 4);
	byte condition = ReadBus(cpu->bus, cpu->pc + 4, 1) << 4 >> 4;
	cpu->pc += 5;
	if (!HasPermission(cpu, addr))
		return false;
	if (cpu->gpregs[condition] != 0) {
		PushInternal(cpu, cpu->pc);
		cpu->pc = addr;
	}
	return true;
}

bool CALLL_IMM(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 4);
	cpu->pc += 4;
	if (!HasPermission(cpu, addr))
		return false;
	if (cpu->lFlag) {
		PushInternal(cpu, cpu->pc);
		cpu->pc = addr;
	}
	return true;
}

bool CALLE_IMM(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 4);
	cpu->pc += 4;
	if (!HasPermission(cpu, addr))
		return false;
	if (cpu->eFlag) {
		PushInternal(cpu, cpu->pc);
		cpu->pc = addr;
	}
	return true;
}

bool CALLG_IMM(CPU* cpu) {
	byte addr = ReadBus(cpu->bus, cpu->pc, 4);
	cpu->pc += 4;
	if (!HasPermission(cpu, addr))
		return false;
	if (cpu->gFlag) {
		PushInternal(cpu, cpu->pc);
		cpu->pc = addr;
	}
	return true;
}