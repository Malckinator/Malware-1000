#include <math.h>

#include "../include/ALUInst.h"

bool INC(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->gpregs[reg]++;
	return true;
}

bool DEC(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->gpregs[reg]--;
	return true;
}

bool INV(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->gpregs[reg] = ~cpu->gpregs[reg];
	return true;
}

bool ADD(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] += cpu->gpregs[reg2];
	return true;
}

bool SUB(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] -= cpu->gpregs[reg2];
	return true;
}

bool ADDC(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] += cpu->gpregs[reg2];
	cpu->cFlag = ((qword) cpu->gpregs[reg1] + (qword) cpu->gpregs[reg2]) >> 32;
	return true;
}

bool SUBB(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] += cpu->gpregs[reg2];
	cpu->cFlag = ((qword)cpu->gpregs[reg1] - (qword)cpu->gpregs[reg2] + ((qword) 1 << 32)) >> 32 ? false : true;
	return true;
}

bool MUL(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] *= cpu->gpregs[reg2];
	return true;
}

bool DIV(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] /= cpu->gpregs[reg2];
	return true;
}

bool POW(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] = powl(cpu->gpregs[reg1], cpu->gpregs[reg2]);
	return true;
}

bool SHL(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] <<= cpu->gpregs[reg2];
	return true;
}

bool SHR(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] >>= cpu->gpregs[reg2];
	return true;
}

bool ROTL(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	byte temp = cpu->gpregs[reg1] >> (32 - cpu->gpregs[reg2]);
	cpu->gpregs[reg1] <<= cpu->gpregs[reg2];
	cpu->gpregs[reg1] += temp;
	return true;
}

bool ROTR(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	byte temp = cpu->gpregs[reg1] << (32 - cpu->gpregs[reg2]);
	cpu->gpregs[reg1] >>= cpu->gpregs[reg2];
	cpu->gpregs[reg1] += temp << 31;
	return true;
}

bool AND(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] &= cpu->gpregs[reg2];
	return true;
}

bool NAND(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] &= cpu->gpregs[reg2];
	cpu->gpregs[reg1] = ~cpu->gpregs[reg1];
	return true;
}

bool OR(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] |= cpu->gpregs[reg2];
	return true;
}

bool NOR(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] |= cpu->gpregs[reg2];
	cpu->gpregs[reg1] = ~cpu->gpregs[reg1];
	return true;
}

bool XOR(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] ^= cpu->gpregs[reg2];
	return true;
}

bool XNOR(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] ^= cpu->gpregs[reg2];
	cpu->gpregs[reg1] = ~cpu->gpregs[reg1];
	return true;
}

bool COMP(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->lFlag = cpu->gpregs[reg1] < cpu->gpregs[reg2];
	cpu->eFlag = cpu->gpregs[reg1] == cpu->gpregs[reg2];
	cpu->gFlag = cpu->gpregs[reg1] > cpu->gpregs[reg2];
	return true;
}

bool COMP_IMM(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte imm = ReadBus(cpu->bus, cpu->pc + 1, 4);
	cpu->pc += 5;
	cpu->lFlag = cpu->gpregs[reg1] < imm;
	cpu->eFlag = cpu->gpregs[reg1] == imm;
	cpu->gFlag = cpu->gpregs[reg1] > imm;
	return true;
}