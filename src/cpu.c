#include <stdlib.h>

#include "../include/inst.h"
#include "../include/cpu.h"

CPU* CreateCPU(Bus* bus) {
	CPU* result = malloc(sizeof(CPU));
	result->bus = bus;
	for (int i = 0; i < 8; i++) {
		result->permTables[i].start = 0;
		result->permTables[i].size = 0;
	}
	for (int i = 0; i < 16; i++) {
		result->gpio[i] = 0;
		result->gpregs[i] = 0;
	}
	result->pc = 0;
	result->sp = 0;
	result->sb = 0;
	result->base = 0;
	result->intrAddr = 0;
	result->perm = 0;
	result->interupt = false;
	result->cFlag = 0;
	result->sFlag = 0;
	result->erFlag = 0;
	result->lFlag = 0;
	result->eFlag = 0;
	result->gFlag = 0;
	return result;
}

void PushInternal(CPU* cpu, dword data) {
	if (cpu->sp - 4 < cpu->sb) {
		cpu->eFlag = true;
		cpu->interupt = true;
		return;
	}
	cpu->sp -= 4;
	PWriteBus(cpu, cpu->sp + 1, data << 24 >> 24, 4);
	PWriteBus(cpu, cpu->sp + 2, data << 16 >> 24, 4);
	PWriteBus(cpu, cpu->sp + 3, data << 8 >> 24, 4);
	PWriteBus(cpu, cpu->sp + 4, data >> 24, 4);
}

dword PopInternal(CPU* cpu) {
	byte b1 = ReadBus(cpu->bus, cpu->sp + 1, 4);
	byte b2 = ReadBus(cpu->bus, cpu->sp + 2, 4);
	byte b3 = ReadBus(cpu->bus, cpu->sp + 3, 4);
	byte b4 = ReadBus(cpu->bus, cpu->sp + 4, 4);
	cpu->sp += 4;
	return b1 + (b2 >> 8) + (b3 >> 16) + (b4 >> 24);
}

bool HasPermission(CPU* cpu, dword addr) {
	if (!cpu->perm)
		return true;

	for (int i = 0; i < 8; i++)
		if (cpu->permTables[i].start <= addr && cpu->permTables[i].start + cpu->permTables[i].size >= addr)
			return false;
	return true;
}

bool PWriteBus(CPU* cpu, dword addr, dword value, byte bytes) {
	if (!HasPermission(cpu, addr))
		return false;
	WriteBus(cpu->bus, addr, value, bytes);
	return true;
}