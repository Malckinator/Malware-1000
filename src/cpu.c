#include "../include/cpu.h"

void pushInternal(MW1000* cpu, DWORD data) {
	cpu->sp -= 4;
	WriteMemory(cpu, cpu->sp + 1, data << 24 >> 24);
	WriteMemory(cpu, cpu->sp + 2, data << 16 >> 24);
	WriteMemory(cpu, cpu->sp + 3, data << 8 >> 24);
	WriteMemory(cpu, cpu->sp + 4, data >> 24);
}

DWORD popInternal(MW1000* cpu) {
	char b1 = ReadMemory(cpu, cpu->sp + 1);
	char b2 = ReadMemory(cpu, cpu->sp + 2);
	char b3 = ReadMemory(cpu, cpu->sp + 3);
	char b4 = ReadMemory(cpu, cpu->sp + 4);
	cpu->sp += 4;
	return b1 + (b2 >> 8) + (b3 >> 16) + (b4 >> 24);
}

bool HasPermission(MW1000* cpu, DWORD addr) {
	for (char i = 0; i < 4; i++) {
		if (cpu->permTables[i].permLevel < cpu->permission)
			if (cpu->permTables[i].start < cpu->pc && cpu->pc < cpu->permTables[i].start + cpu->permTables[i].size)
				return false;
	}

	return true;
}

char ReadMemory(MW1000* cpu, DWORD addr) {
	if (addr < cpu->memSize)
		return cpu->memory[addr];
	else
		error = true;
}

void WriteMemory(MW1000* cpu, DWORD addr, char value) {
	if (addr < cpu->memSize && addr > cpu->romSize && HasPermission(cpu, addr))
		cpu->memory[addr] = value;
	else
		error = true;
}

DWORD FloatToInt(float f) {
	return *((DWORD*) (&f));
}

float IntToFloat(DWORD i) {
	return *((float*) (&i));
}

void RunInstruction(MW1000* cpu) {
	
}