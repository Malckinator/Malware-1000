#include <math.h>

#include "../include/inst.h"
#include "../include/controlInst.h"
#include "../include/memInst.h"
#include "../include/ALUInst.h"

bool (*instructions[])(CPU*) = {
	HLT, DAT, INTR, RET, IRET,																											// Control Instructions
	JMP_REG, JPZ_REG, JNZ_REG, JL_REG, JE_REG, JG_REG, JMP_IMM, JPZ_IMM, JNZ_IMM, JL_IMM, JE_IMM, JG_IMM,								// Jump Instructions
	CALL_REG, CALLZ_REG, CALLNZ_REG, CALLL_REG, CALLE_REG, CALLG_REG, CALL_IMM, CALLZ_IMM, CALLNZ_IMM, CALLL_IMM, CALLE_IMM, CALLG_IMM,	// Call Instructions
	MOV_REG_REG, MOV_REG_IMM_32, MOV_REG_MEMREG_32, MOV_REG_MEMIMM_32, MOV_MEMREG_REG_32, MOV_MEMIMM_REG_32,							// 32-bit Move Instructions
	MOV_REG_IMM_16, MOV_REG_MEMREG_16, MOV_REG_MEMIMM_16, MOV_MEMREG_REG_16, MOV_MEMIMM_REG_16,											// 16-bit Move Instructions
	MOV_REG_IMM_8, MOV_REG_MEMREG_8, MOV_REG_MEMIMM_8, MOV_MEMREG_REG_8, MOV_MEMIMM_REG_8,												// 8-bit Move Instructions
	IN, OUT,																															// I/O Instructions
	MOV_REG_CFLAG, MOV_CFLAG_REG, MOV_REG_SFLAG, MOV_SFLAG_REG, MOV_REG_ERFLAG, MOV_ERFLAG_REG,	MOV_REG_RFLAG, MOV_RFLAG_REG,			// Move Flag Instructions
	MOV_REG_INTRADDR, MOV_INTRADDR_REG, MOV_SP_REG, MOV_REG_SP, MOV_SB_REG, MOV_REG_SB,	MOV_B_REG, MOV_REG_B,							// Move Register Instructions
	STPS, STPL,	STU,																													// Permission Instructions
	INC, DEC, ADD, SUB, ADDC, SUBB, MUL, DIV, POW,																						// ALU Binary Instructions
	SHL, SHR, ROTL, ROTR, AND, NAND, OR, NOR, XOR, XNOR, COMP, COMP_IMM																	// ALU Bitwise Instructions
};

void RunInstruction(CPU* cpu) {
	byte inst = ReadBus(cpu->bus, cpu->pc, 1);
	cpu->pc++;
	if (inst > 83)
		return;
	if (!instructions[inst](cpu)) {
		cpu->erFlag = true;
		cpu->interupt = true;
	}

	if (cpu->interupt) {
		PushInternal(cpu, cpu->perm);
		PushInternal(cpu, cpu->pc);
		cpu->perm = 0;
		cpu->pc = cpu->intrAddr;
	}
}