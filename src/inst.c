#include "../include/cpu.h"

void NOOP(MW1000* cpu) {
	return;
}

void HLT(MW1000* cpu) {
	cpu->pc--;
}

void INTR(MW1000* cpu) {
	cpu->sp -= 3;
	WriteMemory(cpu, cpu->sp, cpu->permission);
	cpu->sp--;
	cpu->iFlag = true;
}

void RET(MW1000* cpu) {
	char b1 = ReadMemory(cpu, cpu->sp + 1);
	char b2 = ReadMemory(cpu, cpu->sp + 2);
	char b3 = ReadMemory(cpu, cpu->sp + 3);
	char b4 = ReadMemory(cpu, cpu->sp + 4);
	cpu->sp += 4;
	cpu->pc = b1 + (b2 << 8) + (b3 << 16) + (b4 << 24);
}

void IRET(MW1000* cpu) {
	RET(cpu);
	cpu->permission = ReadMemory(cpu, cpu->sp + 1);
	cpu->sp += 4;
}

void JMP(MW1000* cpu) {
	char b1 = ReadMemory(cpu, cpu->pc);
	char b2 = ReadMemory(cpu, cpu->pc + 1);
	char b3 = ReadMemory(cpu, cpu->pc + 2);
	char b4 = ReadMemory(cpu, cpu->pc + 3);
	cpu->pc = b1 + (b2 << 8) + (b3 << 16) + (b4 << 24);
}

void JPZ(MW1000* cpu) {
	char b1 = ReadMemory(cpu, cpu->pc);
	char b2 = ReadMemory(cpu, cpu->pc + 1);
	char b3 = ReadMemory(cpu, cpu->pc + 2);
	char b4 = ReadMemory(cpu, cpu->pc + 3);
	cpu->pc += 4;
	if (b1 + (b2 << 8) + (b3 << 16) + (b4 << 24) == 0)
		JMP(cpu);
}

void JNZ(MW1000* cpu) {
	char b1 = ReadMemory(cpu, cpu->pc);
	char b2 = ReadMemory(cpu, cpu->pc + 1);
	char b3 = ReadMemory(cpu, cpu->pc + 2);
	char b4 = ReadMemory(cpu, cpu->pc + 3);
	cpu->pc += 4;
	if (b1 + (b2 << 8) + (b3 << 16) + (b4 << 24) != 0)
		JMP(cpu);
}

void JCZ(MW1000* cpu) {
	if (cpu->cFlag == 0)
		JMP(cpu);
}

void JNCZ(MW1000* cpu) {
	if (cpu->cFlag != 0)
		JMP(cpu);
}

void CALL(MW1000* cpu) {
	WriteMemory(cpu, cpu->sp + 1, cpu->pc << 24 >> 24);
	WriteMemory(cpu, cpu->sp + 2, cpu->pc << 16 >> 24);
	WriteMemory(cpu, cpu->sp + 3, cpu->pc << 8 >> 24);
	WriteMemory(cpu, cpu->sp + 4, cpu->pc >> 24);
	cpu->sp += 4;
	JMP(cpu);
}

void CLZ(MW1000* cpu) {
	char b1 = ReadMemory(cpu, cpu->pc);
	char b2 = ReadMemory(cpu, cpu->pc + 1);
	char b3 = ReadMemory(cpu, cpu->pc + 2);
	char b4 = ReadMemory(cpu, cpu->pc + 3);
	cpu->pc += 4;
	if (b1 + (b2 << 8) + (b3 << 16) + (b4 << 24) == 0)
		CALL(cpu);
}

void CNZ(MW1000* cpu) {
	char b1 = ReadMemory(cpu, cpu->pc);
	char b2 = ReadMemory(cpu, cpu->pc + 1);
	char b3 = ReadMemory(cpu, cpu->pc + 2);
	char b4 = ReadMemory(cpu, cpu->pc + 3);
	cpu->pc += 4;
	if (b1 + (b2 << 8) + (b3 << 16) + (b4 << 24) == 0)
		CALL(cpu);
}

void CPC(MW1000* cpu) {
	if (cpu->cFlag == 0)
		CALL(cpu);
}

void CNC(MW1000* cpu) {
	if (cpu->cFlag != 0)
		CALL(cpu);
}

void STP(MW1000* cpu) {
	char p = ReadMemory(cpu, cpu->pc);
	cpu->pc++;
	if (cpu->permission > p)
		cpu->permission = p;
}




void MRR(MW1000* cpu) {
	char reg1 = cpu->memory[cpu->pc] >> 4;
	char reg2 = cpu->memory[cpu->pc] << 4 >> 4;
	cpu->registers[reg1] = cpu->registers[reg2];
}

void MRM(MW1000* cpu) {
	char reg = cpu->memory[cpu->pc];
	char b1 = ReadMemory(cpu, cpu->pc + 1);
	char b2 = ReadMemory(cpu, cpu->pc + 2);
	char b3 = ReadMemory(cpu, cpu->pc + 3);
	char b4 = ReadMemory(cpu, cpu->pc + 4);
	cpu->pc += 5;
	DWORD addr = b1 + (b2 << 8) + (b3 << 16) + (b4 << 24);
	if (reg > 15) {
		error = true;
		return;
	}
	WriteMemory(cpu, addr, cpu->registers[reg] << 24 >> 24);
	WriteMemory(cpu, addr + 1, cpu->registers[reg] << 16 >> 24);
	WriteMemory(cpu, addr + 2, cpu->registers[reg] << 8 >> 24);
	WriteMemory(cpu, addr + 3, cpu->registers[reg] >> 24);
}

void MMR(MW1000* cpu) {
	char b1 = ReadMemory(cpu, cpu->pc);
	char b2 = ReadMemory(cpu, cpu->pc + 1);
	char b3 = ReadMemory(cpu, cpu->pc + 2);
	char b4 = ReadMemory(cpu, cpu->pc + 3);
	char reg = cpu->memory[cpu->pc + 4];
	if (reg > 15) {
		error = true;
		return;
	}
	DWORD addr = b1 + (b2 << 8) + (b3 << 16) + (b4 << 24);
	cpu->registers[reg] = ReadMemory(cpu, addr) + (ReadMemory(cpu, addr + 1) << 8) + (ReadMemory(cpu, addr + 2) << 16) + (ReadMemory(cpu, addr + 3) << 24);
}

void MRMW(MW1000* cpu) {
	char reg = cpu->memory[cpu->pc];
	char b1 = ReadMemory(cpu, cpu->pc + 1);
	char b2 = ReadMemory(cpu, cpu->pc + 2);
	char b3 = ReadMemory(cpu, cpu->pc + 3);
	char b4 = ReadMemory(cpu, cpu->pc + 4);
	cpu->pc += 5;
	DWORD addr = b1 + (b2 << 8) + (b3 << 16) + (b4 << 24);
	if (reg > 15) {
		error = true;
		return;
	}
	WriteMemory(cpu, addr, cpu->registers[reg] << 24 >> 24);
	WriteMemory(cpu, addr + 1, cpu->registers[reg] << 16 >> 24);
}

void MMRW(MW1000 * cpu) {
	char b1 = ReadMemory(cpu, cpu->pc);
	char b2 = ReadMemory(cpu, cpu->pc + 1);
	char b3 = ReadMemory(cpu, cpu->pc + 2);
	char b4 = ReadMemory(cpu, cpu->pc + 3);
	char reg = cpu->memory[cpu->pc + 4];
	if (reg > 15) {
		error = true;
		return;
	}
	DWORD addr = b1 + (b2 << 8) + (b3 << 16) + (b4 << 24);
	cpu->registers[reg] = ReadMemory(cpu, addr) + (ReadMemory(cpu, addr + 1) << 8);
}

void MRMW(MW1000* cpu) {
	char reg = cpu->memory[cpu->pc];
	char b1 = ReadMemory(cpu, cpu->pc + 1);
	char b2 = ReadMemory(cpu, cpu->pc + 2);
	char b3 = ReadMemory(cpu, cpu->pc + 3);
	char b4 = ReadMemory(cpu, cpu->pc + 4);
	cpu->pc += 5;
	DWORD addr = b1 + (b2 << 8) + (b3 << 16) + (b4 << 24);
	if (reg > 15) {
		error = true;
		return;
	}
	WriteMemory(cpu, addr, cpu->registers[reg] << 24 >> 24);
}

void MMRB(MW1000* cpu) {
	char b1 = ReadMemory(cpu, cpu->pc);
	char b2 = ReadMemory(cpu, cpu->pc + 1);
	char b3 = ReadMemory(cpu, cpu->pc + 2);
	char b4 = ReadMemory(cpu, cpu->pc + 3);
	char reg = cpu->memory[cpu->pc + 4];
	if (reg > 15) {
		error = true;
		return;
	}
	DWORD addr = b1 + (b2 << 8) + (b3 << 16) + (b4 << 24);
	cpu->registers[reg] = ReadMemory(cpu, addr);
}

void PUSH(MW1000* cpu) {
	char reg = ReadMemory(cpu, cpu->pc);
	if (reg > 15) {
		error = true;
		return;
	}
	cpu->pc++;
	char b1 = cpu->registers[reg] << 24 >> 24;
	char b2 = cpu->registers[reg] << 16 >> 24;
	char b3 = cpu->registers[reg] << 8 >> 24;
	char b4 = cpu->registers[reg] >> 24;
	cpu->sp -= 4;
	WriteMemory(cpu, cpu->sp + 1, b1);
	WriteMemory(cpu, cpu->sp + 2, b2);
	WriteMemory(cpu, cpu->sp + 3, b3);
	WriteMemory(cpu, cpu->sp + 4, b4);
}

void POP(MW1000* cpu) {
	char reg = ReadMemory(cpu, cpu->pc);
	cpu->pc++;
	cpu->sp += 4;
	char b1 = ReadMemory(cpu, cpu->sp + 1);
	char b2 = ReadMemory(cpu, cpu->sp + 2);
	char b3 = ReadMemory(cpu, cpu->sp + 3);
	char b4 = ReadMemory(cpu, cpu->sp + 4);
	if (reg > 15) {
		error = true;
		return;
	}
	cpu->registers[reg] = b1 + (b2 << 8) + (b3 << 16) + (b4 << 24);
}

void IN(MW1000* cpu) {
}

void OUT(MW1000* cpu) {
}

void STTS(MW1000* cpu) {
}

void STTL(MW1000* cpu) {
}

void STTP(MW1000* cpu) {
}

void STSP(MW1000* cpu) {
}