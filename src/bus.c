#include <stdlib.h>

#include "../include/bus.h"

MemoryRegion* CreateMemoryRegion(dword start, dword end, dword (*read)(MemoryRegion*, dword, byte), void (*write)(MemoryRegion*, dword, dword, byte)) {
	MemoryRegion* result = malloc(sizeof(MemoryRegion));
	result->start = start;
	result->end = end;
	result->read = read;
	result->write = write;
	return result;
}

Bus* CreateBus(int count) {
	Bus* result = malloc(sizeof(Bus));
	result->count = count;
	result->regions = malloc(count * sizeof(MemoryRegion));
	return result;
}

dword ReadBus(Bus* bus, dword addr, byte bytes) {
	for (int i = 0; i < bus->count; i++) {
		if (bus->regions[i]->start <= addr && bus->regions[i]->end >= addr)
			return bus->regions[i]->read(bus->regions[i], addr, bytes);
	}

	return 0;
}

void WriteBus(Bus* bus, dword addr, dword data, byte bytes) {
	for (int i = 0; i < bus->count; i++) {
		if (bus->regions[i]->start <= addr && bus->regions[i]->end >= addr) {
			bus->regions[i]->write(bus->regions[i], addr, data, bytes);
			return;
		}
	}
}