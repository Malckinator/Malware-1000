#include "../include/memInst.h"

bool MOV_REG_REG(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] = cpu->gpregs[reg2];
	return true;
}

bool MOV_REG_IMM_32(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	dword imm = ReadBus(cpu->bus, cpu->pc, 4);
	cpu->pc += 4;
	cpu->gpregs[reg] = imm;
	return true;
}

bool MOV_REG_MEMREG_32(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] = ReadBus(cpu->bus, cpu->gpregs[reg2], 4);
	return true;
}

bool MOV_REG_MEMIMM_32(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	dword imm = ReadBus(cpu->bus, cpu->pc, 4);
	cpu->pc += 4;
	cpu->gpregs[reg] = ReadBus(cpu->bus, imm, 4);
	return true;
}

bool MOV_MEMREG_REG_32(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	return PWriteBus(cpu, cpu->gpregs[reg1] + cpu->base, cpu->gpregs[reg2], 4);
}

bool MOV_MEMIMM_REG_32(CPU* cpu) {
	byte imm = ReadBus(cpu->bus, cpu->pc, 4);
	cpu->pc += 4;
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	return PWriteBus(cpu, imm + cpu->base, cpu->gpregs[reg], 4);
}

bool MOV_REG_IMM_16(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	dword imm = ReadBus(cpu->bus, cpu->pc, 2);
	cpu->pc += 2;
	cpu->gpregs[reg] = imm;
	return true;
}

bool MOV_REG_MEMREG_16(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] = ReadBus(cpu->bus, cpu->gpregs[reg2], 2);
	return true;
}

bool MOV_REG_MEMIMM_16(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	dword imm = ReadBus(cpu->bus, cpu->pc, 4);
	cpu->pc += 4;
	cpu->gpregs[reg] = ReadBus(cpu->bus, imm, 2);
	return true;
}

bool MOV_MEMREG_REG_16(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	return PWriteBus(cpu, cpu->gpregs[reg1] + cpu->base, cpu->gpregs[reg2], 2);
}

bool MOV_MEMIMM_REG_16(CPU* cpu) {
	byte imm = ReadBus(cpu->bus, cpu->pc, 4);
	cpu->pc += 4;
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	return PWriteBus(cpu, imm + cpu->base, cpu->gpregs[reg], 2);
}

bool MOV_REG_IMM_8(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	dword imm = ReadBus(cpu->bus, cpu->pc, 1);
	cpu->pc += 1;
	cpu->gpregs[reg] = imm;
	return true;
}

bool MOV_REG_MEMREG_8(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg1] = ReadBus(cpu->bus, cpu->gpregs[reg2], 1);
	return true;
}

bool MOV_REG_MEMIMM_8(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	dword imm = ReadBus(cpu->bus, cpu->pc, 4);
	cpu->pc += 4;
	cpu->gpregs[reg] = ReadBus(cpu->bus, imm, 1);
	return true;
}

bool MOV_MEMREG_REG_8(CPU* cpu) {
	byte reg1 = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg2 = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	return PWriteBus(cpu, cpu->gpregs[reg1] + cpu->base, cpu->gpregs[reg2], 1);
}

bool MOV_MEMIMM_REG_8(CPU* cpu) {
	byte imm = ReadBus(cpu->bus, cpu->pc, 4);
	cpu->pc += 4;
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	return PWriteBus(cpu, imm + cpu->base, cpu->gpregs[reg], 1);
}

bool IN(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte port = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpregs[reg] = cpu->gpio[port];
	return true;
}

bool OUT(CPU* cpu) {
	byte port = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	cpu->gpio[port] = cpu->gpregs[reg];
	return true;
}

bool MOV_REG_CFLAG(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->gpregs[reg] = cpu->cFlag;
	return true;
}

bool MOV_CFLAG_REG(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->cFlag = cpu->gpregs[reg] << 31 >> 31;
	return true;
}

bool MOV_REG_SFLAG(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->gpregs[reg] = cpu->sFlag;
	return true;
}

bool MOV_SFLAG_REG(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->sFlag = cpu->gpregs[reg] << 31 >> 31;
	return true;
}

bool MOV_REG_ERFLAG(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->gpregs[reg] = cpu->erFlag;
	return true;
}

bool MOV_ERFLAG_REG(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->erFlag = cpu->gpregs[reg] << 31 >> 31;
	return true;
}

bool LDP(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->gpregs[reg] = cpu->perm;
	return true;
}

bool MOV_REG_SP(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->gpregs[reg] = cpu->sp;
	return true;
}

bool MOV_SP_REG(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->sp = cpu->gpregs[reg];
	return true;
}

bool MOV_REG_SB(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->gpregs[reg] = cpu->sb;
	return true;
}

bool MOV_SB_REG(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->sb = cpu->gpregs[reg];
	return true;
}

bool MOV_REG_INTRADDR(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->gpregs[reg] = cpu->intrAddr;
	return true;
}

bool MOV_INTRADDR_REG(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	cpu->intrAddr = cpu->gpregs[reg];
	return true;
}

bool STP(CPU* cpu) {
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	cpu->pc++;
	if (cpu->gpregs[reg] > 15 || cpu->perm <= cpu->gpregs[reg])
		return false;
	cpu->perm = cpu->gpregs[reg];
	return true;
}

bool STPP(CPU* cpu) {
	if (cpu->perm != 0)
		return false;
	byte table = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	if (table > 15)
		return false;
	cpu->permTables[table].permLevel = (byte)cpu->gpregs[reg];
	return true;
}

bool STPS(CPU* cpu) {
	if (cpu->perm != 0)
		return false;
	byte table = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	if (table > 15)
		return false;
	cpu->permTables[table].start = cpu->gpregs[reg];
	return true;
}

bool STPL(CPU* cpu) {
	if (cpu->perm != 0)
		return false;
	byte table = ReadBus(cpu->bus, cpu->pc, 1) >> 4;
	byte reg = ReadBus(cpu->bus, cpu->pc, 1) << 4 >> 4;
	cpu->pc++;
	if (table > 15)
		return false;
	cpu->permTables[table].size = cpu->gpregs[reg];
	return true;
}