#include <stdio.h>
#include <stdlib.h>

#include "../include/cpu.h"
#include "../include/inst.h"

void ROMWrite(MemoryRegion* region, dword addr, dword value, byte bytes) {
	switch (bytes) { // If you don't put breaks in your switch statments, they will fall through to the one below, which is what I want.
	case 4:
		((byte*)region->data)[addr + 3] = value >> 24;
	case 3:
		((byte*)region->data)[addr + 2] = value << 8 >> 24;
	case 2:
		((byte*)region->data)[addr + 1] = value << 16 >> 24;
	default:
		((byte*)region->data)[addr] = value << 24 >> 24;
		break;
	}
}

dword ROMRead(MemoryRegion* region, dword addr, byte bytes) {
	/* I couldn't get it working :(
	dword value = 0;
	for (int i = 0; i < bytes; i++) {
		value += (((byte*) region->data)[addr] << (8 * i));
	}
	return value;
	*/

	switch (addr) {
	case 0:
		return 64;
	case (dword) 2:
		return 5;
	case (dword) 3:
		return 1 << 4;
	default:
		return 0;
	}
}

void DisplayCPU(CPU* cpu) {
	printf("\n\nPC = %08xh|SP = %08xh\n\nA = %08xh|B = %08xh|C = %08xh|D = %08xh\nE = %08xh|F = %08xh|G = %08xh|H = %08xh\nI = %08xh|J = %08xh|K = %08xh|L = %08xh\nM = %08xh|N = %08xh|O = %08xh|P = %08xh",
		cpu->pc, cpu->sp, cpu->gpregs[0], cpu->gpregs[1],
		cpu->gpregs[2], cpu->gpregs[3], cpu->gpregs[4], cpu->gpregs[5],
		cpu->gpregs[6], cpu->gpregs[7], cpu->gpregs[8], cpu->gpregs[9],
		cpu->gpregs[10], cpu->gpregs[11], cpu->gpregs[12], cpu->gpregs[13],
		cpu->gpregs[14], cpu->gpregs[15]);
}

#ifndef VISUAL_STUDIO
#include <pthread.h>

void* CPUThread(void* vargs) {
	CPU* cpu = (CPU*)vargs;
	while (true) {
		RunInstruction(cpu);
	}
	return NULL;
}

#endif

int main() {
	Bus* bus = CreateBus(1);
	MemoryRegion* rom = CreateMemoryRegion(0, 5, ROMRead, ROMWrite);
	rom->data = malloc(5 * sizeof(byte));
	bus->regions[0] = rom;

	WriteBus(bus, 0, 63, 1);
	WriteBus(bus, 1, 0, 1);
	WriteBus(bus, 2, 5, 1);
	WriteBus(bus, 3, 1, 1);
	
	CPU* cpu = CreateCPU(bus);
#ifdef VISUAL_STUDIO
	while (true) {
		DisplayCPU(cpu);
		RunInstruction(cpu);
	}
#else
	pthread_t id;
	pthread_create(&id, NULL, CPUThread, (void*)cpu);
	while (true) {
		DisplayCPU(cpu);
	}
#endif
	return 0;
}